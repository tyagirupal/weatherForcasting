<section class="container py-4" *ngIf="current as c">
  <!-- Top bar -->
  <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-4">
    <mat-slide-toggle (change)="toggleDarkMode($event.checked)">Dark mode</mat-slide-toggle>

    <form [formGroup]="search"
          class="search d-flex align-items-center gap-2 flex-grow-1 flex-md-grow-0"
          (ngSubmit)="onSubmitSearch()">

      <mat-form-field appearance="outline" class="m-0 flex-grow-1" style="min-width:260px;">
        <mat-label>Search city</mat-label>
        <input matInput placeholder="Type a city (e.g., Gurugram)"
               formControlName="q"
               [matAutocomplete]="auto"
               maxlength="60">
        <button matSuffix mat-icon-button aria-label="clear"
                *ngIf="search.get('q')?.value"
                (click)="search.get('q')?.reset(); suggestions=[]">
          <mat-icon>close</mat-icon>
        </button>

        <mat-hint align="start">Type at least 3 letters</mat-hint>

        <!-- NOTE: added class="city-auto" for styling the floating panel -->
        <mat-autocomplete #auto="matAutocomplete"
                          class="city-auto"
                          (optionSelected)="onCitySelected($event)">
          <mat-option *ngIf="isSearching" disabled>
            <mat-progress-spinner diameter="18" mode="indeterminate"></mat-progress-spinner>
            &nbsp;Searching…
          </mat-option>
          <ng-container *ngIf="!isSearching">
            <mat-option *ngFor="let s of suggestions"
                        [value]="s.name + ', ' + (s.state ? s.state + ', ' : '') + s.country">
              {{ s.name }} <span class="text-muted small">{{ s.state ? s.state + ', ' : '' }}{{ s.country }}</span>
            </mat-option>
            <mat-option *ngIf="suggestions.length===0">No suggestions</mat-option>
          </ng-container>
        </mat-autocomplete>
      </mat-form-field>

      <button mat-flat-button color="primary" type="submit"
              [disabled]="(search.get('q')?.value || '').trim().length < 3">
        <mat-icon class="me-1">search</mat-icon> Search
      </button>

      <button mat-flat-button color="primary" type="button" (click)="useCurrentLocation()">
        <mat-icon class="me-1">my_location</mat-icon> Current location
      </button>
    </form>
  </div>

  <!-- Current weather -->
  <div class="row g-3">
    <div class="col-12 col-lg-4">
      <mat-card class="h-100">
        <mat-card-content class="p-4 text-center">
          <h3 class="mb-1">{{ c.cityName }}, {{ c.country }}</h3>
          <div class="fs-5 text-muted">{{ now | date:'EEEE, d MMM' }}</div>

          <div class="display-6 fw-bold my-3">
            {{ c.temp | number:'1.0-0' }}<sup>°</sup>C
          </div>

          <img [src]="iconUrl(c.icon)" alt="icon" class="weather-icon mb-1">
          <div class="text-capitalize">{{ c.description }}</div>

          <div class="mt-3 small text-muted">H: {{ c.tempMax | number:'1.0-0' }}° • L: {{ c.tempMin | number:'1.0-0' }}°</div>

          <div class="mt-3 d-flex justify-content-center gap-3 flex-wrap small">
            <span><mat-icon class="me-1">water_drop</mat-icon>{{ c.humidity }}%</span>
            <span><mat-icon class="me-1">air</mat-icon>{{ c.windKmh }} km/h</span>
            <span><mat-icon class="me-1">compress</mat-icon>{{ c.pressure }} hPa</span>
            <span><mat-icon class="me-1">cloud</mat-icon>{{ c.clouds }}%</span>
          </div>

          <div class="mt-3 d-flex justify-content-center gap-4 small align-items-center">
            <span class="d-flex align-items-center">
              <img src="assets/icons/sunrise.png" alt="" class="sun-ico me-1"> {{ c.sunrise * 1000 | date:'shortTime' }}
            </span>
            <span class="d-flex align-items-center">
              <img src="assets/icons/sunset.png" alt="" class="sun-ico me-1"> {{ c.sunset * 1000 | date:'shortTime' }}
            </span>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Forecasts -->
    <div class="col-12 col-lg-8">
      <!-- Next 24 hours -->
      <mat-card>
        <mat-card-header>
          <mat-card-title>Next 24 hours (3-hourly)</mat-card-title>
        </mat-card-header>
        <mat-divider></mat-divider>
        <mat-card-content class="p-3">
          <div class="hours-grid">
            <div class="tile d-flex flex-column align-items-center p-3" *ngFor="let h of next24h">
              <div class="fw-semibold">{{ h.at | date:'h a' }}</div>
              <img [src]="iconUrl(h.icon)" alt="" class="forecast-icon my-2">
              <div class="fw-bold">{{ h.temp | number:'1.0-0' }}°C</div>
              <div class="small text-capitalize text-muted">{{ h.description }}</div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <div class="mt-3"></div>

      <!-- Upcoming 5 days -->
      <mat-card>
        <mat-card-header>
          <mat-card-title>Upcoming 5 days</mat-card-title>
        </mat-card-header>
        <mat-divider></mat-divider>
        <mat-card-content class="p-3">
          <div class="days-grid">
            <div class="tile d-flex flex-column align-items-center p-3" *ngFor="let d of forecast5d">
              <div class="fw-semibold">{{ d.date | date:'EEE, d MMM' }}</div>
              <img [src]="iconUrl(d.icon)" alt="" class="forecast-icon my-2">
              <div class="fw-bold">{{ d.tempMax | number:'1.0-0' }}°C</div>
              <div class="small text-capitalize text-muted">{{ d.description }}</div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</section>

<!-- Initial empty state -->
<section class="container py-5" *ngIf="!current">
  <div class="text-center">
    <h3>Weather</h3>
    <p class="text-muted">Use your current location or search a city to see the weather.</p>
    <button mat-flat-button color="primary" (click)="useCurrentLocation()">
      <mat-icon class="me-1">my_location</mat-icon> Use current location
    </button>
  </div>
</section>
